<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Synthetic Population Catalyst - 11&nbsp; Modelling methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./understanding_data_schema.html" rel="next">
<link href="./understanding_technical_overview.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./understanding_introduction.html">Understanding SPC</a></li><li class="breadcrumb-item"><a href="./understanding_modelling_methods.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modelling methods</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Synthetic Population Catalyst</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/alan-turing-institute/uatk-spc/tree/main/docs" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./Synthetic-Population-Catalyst.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Using SPC</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_outputs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">SPC Outputs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_england_outputs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Outputs for England (Counties)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_wales_outputs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Outputs for Wales (ITL regions)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_scotland_outputs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Outputs for Scotland (Police Divisions)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_use_output.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">How to use the output file</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Full tool installation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_custom_areas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Running a custom area</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Understanding SPC</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./understanding_introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./understanding_technical_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">The SPC pipeline</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./understanding_modelling_methods.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modelling methods</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./understanding_data_schema.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Data schema</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./understanding_data_sources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Data sources</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Validation</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Advanced</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./advanced_developer_guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Developer guide</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./advanced_code_walkthrough.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Code walkthrough</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./advanced_performance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Performance</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#spenser-and-quant" id="toc-spenser-and-quant" class="nav-link active" data-scroll-target="#spenser-and-quant"><span class="header-section-number">11.1</span> SPENSER and QUANT</a></li>
  <li><a href="#bmi-estimation" id="toc-bmi-estimation" class="nav-link" data-scroll-target="#bmi-estimation"><span class="header-section-number">11.2</span> BMI estimation</a></li>
  <li><a href="#income-data" id="toc-income-data" class="nav-link" data-scroll-target="#income-data"><span class="header-section-number">11.3</span> Income data</a>
  <ul class="collapse">
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods"><span class="header-section-number">11.3.1</span> Methods</a></li>
  <li><a href="#comparison-to-reference-values-from-ons" id="toc-comparison-to-reference-values-from-ons" class="nav-link" data-scroll-target="#comparison-to-reference-values-from-ons"><span class="header-section-number">11.3.2</span> Comparison to reference values from ONS</a></li>
  </ul></li>
  <li><a href="#commuting-flows" id="toc-commuting-flows" class="nav-link" data-scroll-target="#commuting-flows"><span class="header-section-number">11.4</span> Commuting flows</a>
  <ul class="collapse">
  <li><a href="#list-of-all-workplaces-in-gb" id="toc-list-of-all-workplaces-in-gb" class="nav-link" data-scroll-target="#list-of-all-workplaces-in-gb"><span class="header-section-number">11.4.1</span> List of all workplaces in GB</a></li>
  <li><a href="#usage-inside-spc" id="toc-usage-inside-spc" class="nav-link" data-scroll-target="#usage-inside-spc"><span class="header-section-number">11.4.2</span> Usage inside SPC</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./understanding_introduction.html">Understanding SPC</a></li><li class="breadcrumb-item"><a href="./understanding_modelling_methods.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modelling methods</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modelling methods</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>We present here the theoretical principles behind the modelling done in SPC and point to the parts of the code where they are implemented.</p>
<section id="spenser-and-quant" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="spenser-and-quant"><span class="header-section-number">11.1</span> SPENSER and QUANT</h2>
<p>The generation of the population data by <a href="https://github.com/nismod/microsimulation">SPENSER</a> (Synthetic Population Estimation and Scenario Projection) model and the modelling of trips to schools and retail by <a href="https://github.com/maptube/QUANT_RAMP">QUANT</a> are detailed in</p>
<blockquote class="blockquote">
<p>Lomax N et al.&nbsp;An Open-Source Model for Projecting Small Area Demographic and Land-Use Change. Geographical analysis, 54(3), 599-622 (2022). (<a href="https://doi.org/10.1111/gean.12320">DOI</a>)</p>
</blockquote>
<p>and</p>
<blockquote class="blockquote">
<p>Spooner F et al.&nbsp;A dynamic microsimulation model for epidemics. Soc Sci Med., 291:114461 (2021). (<a href="https://doi.org/10.1016/j.socscimed.2021.114461">DOI</a>)</p>
</blockquote>
</section>
<section id="bmi-estimation" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="bmi-estimation"><span class="header-section-number">11.2</span> BMI estimation</h2>
<p>Body Max Index (BMI) is calculated for each individual from the <a href="https://digital.nhs.uk/data-and-information/areas-of-interest/public-health/health-survey-for-england---health-social-care-and-lifestyles#top">Health Survey for England 2019</a> (access needs to be requested to the UK Data Service). This calculation is independent from the matching with the Heath Survey that happens during the data preparation step, therefore the BMI values will not match the ones that could be obtained from the Health Survey identifiers included in the output. As the BMI variable is not necessarily independent from the other health variables (diabetes etc.), the new variable should only be used for studies where all other variables are considered equal. The new variable is continuous (a float) instead of categorical.</p>
<p>According to the HSE 2019, the distribution of BMI values should follow figure 1. The socio-economic category variable was discarded for the modelling as it is not independent from the other variables, and “mixed” and “other” ethnicity categories have been merged due to small sample sizes.</p>
<p><img src="img/BMIStart.png" align="left" width="600"> Figure 1. BMI per age. Columns represent ethnicity (White, Black, Asian, Other), and the rows sex (female, male).</p>
<p>The distribution for each age group is a gamma distribution. See figure 2.</p>
<p><img src="img/BMIDistrib.png" align="left" width="600"> Figure 2. Distribution of BMI values for white females aged 30-34.</p>
<p>Due to small sample sizes, the BMI is calculated for each individual depending on their age according to a gamma distribution whose mean is the mean for the corresponding age, sex and ethnicity (thick line in figure 1), but whose variance is only determined by the total variance by sex and ethnicity. The resulting BMI values were validated for Bedfordshire, and correlations of 0.93 and 0.97 were found between the mean and variance of the modelled data compared to those for the reference HSE 2019 data. See figure 3. The distribution per age, as in figure 1, were also validated.</p>
<p><img src="img/BMIControl.png" align="left" width="600"> Figure 3. Modelled mean and variance compared to the reference mean and variance from the HSE 2019 data for each of the eight categories of figure 1.</p>
<p>The <i>R</i> code for this modelling are l. 239-406 of this <a href="https://github.com/alan-turing-institute/uatk-spc/blob/main/scripts/data_prep/raw_to_prepared.R">script</a>, and the validation is included in the legacy version, <a href="https://github.com/alan-turing-institute/uatk-spc/blob/main/scripts/data_prep/legacy/createBMI.R">here</a>.</p>
</section>
<section id="income-data" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="income-data"><span class="header-section-number">11.3</span> Income data</h2>
<p>This modelling is based on the 2020 revised edition of the <a href="https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/earningsandworkinghours/datasets/regionbyoccupation4digitsoc2010ashetable15">Earnings and hours worked, region by occupation by four-digit SOC: ASHE Table 15</a> database from ONS. Some percentiles for employees’ gross hourly salaries are provided for each full-time and part-time job according to their four-digit SOC classification per region, and separated by sex. It is supported by this <a href="https://github.com/alan-turing-institute/uatk-spc/blob/main/scripts/data_prep/raw_to_prepared_Income.R">script</a>.</p>
<section id="methods" class="level3" data-number="11.3.1">
<h3 data-number="11.3.1" class="anchored" data-anchor-id="methods"><span class="header-section-number">11.3.1</span> Methods</h3>
<p>The data are far from complete (only about 15% of all possible values), especially for the highest deciles. We found that the missing values amongst the partially filled SOCs could be estimated by interpolating an order 3 polynomial to the existing values. We found that the order 3 polynomials were a good fit for most categories (93.11%). SOCs with too many missing values are given the value for the category that is immediately higher in the SOC hierarchy. For some jobs, the highest percentiles seem capped, making the polynomial fitting fail. In that case, we have replaced the unknown values with the highest known value (as there is no clear and systematic fitting for these special cases). In addition, the highest decile is never detailed in the data, which means that the highest salaries are underestimated in the model (and exceptionally high salaries are not present). The result of this phase is four tables {male full-time, male part-time, female full-time, female part-time} containing the coefficients of the fitted order 3 polynomials, with an optional cap when relevant. This step is done in section 1 of the script.</p>
<p>A percentile is chosen randomly (uniformly) for each individual in England, and the salary is then deduced according to their full-time/part-time status, region, sex and SOC category. <a href="https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/earningsandworkinghours/datasets/agegroupashetable6">Age data</a> from ONS are then integrated. Part of the differences that can be observed between different age groups is already taken into account through the SOC variable, since it is expected to evolve throughout an individual’s career. To avoid counting this dependency twice, we compute the residual between the results of the initial modelling that does not take into account age and the expected results by age group according to the data. We then deduce a function that modifies a posteriori the estimated salary of an individual depending on their age, so that the salaries sum correctly by age groups. This step is done in sections 2 to 4 of the script.</p>
<p>To get the number of hours worked per week, we also use the ASHE Table 15. Since only minimal differences are observed between SOC categories, we simply complete missing values by approximating them by values of the category that is immediately higher within the SOC hierarchy. This step is done in section 5 of the script.</p>
<p>When added to the SPC population data, a basic hourly salary column is added, as well as a corresponding annual salary deduced from the number of worked hours. In addition, we repeat this process for all individuals that are categorised as ‘Self-employed’ or ‘Employee unspecified’ by the Time Use Survey matching,, as if they were full time employees. These values are recorded in the columns <code>IncomeHAsIF</code> and <code>IncomeYAsIf</code>.</p>
</section>
<section id="comparison-to-reference-values-from-ons" class="level3" data-number="11.3.2">
<h3 data-number="11.3.2" class="anchored" data-anchor-id="comparison-to-reference-values-from-ons"><span class="header-section-number">11.3.2</span> Comparison to reference values from ONS</h3>
<p>We compare the results of the modelling to the raw datasets from ONS.</p>
<ul>
<li><code>Mod</code> for modelled</li>
<li><code>M</code> for male</li>
<li><code>F</code> for female</li>
<li><code>H</code> for hourly gross salary</li>
<li><code>Y</code> for annual gross salary</li>
<li><code>FT</code> for full-Time</li>
<li><code>PT</code> for part-Time</li>
<li>Only individuals recorded as employees (i.e.&nbsp;not self-employed) are taken into account in this section.</li>
</ul>
<p><strong>Number of employees per sex and full-time/part-time classification</strong></p>
<p>The numbers given by ONS vary from dataset to dataset and are reported by ONS as indicative only. For the modelled values, we give the total number of individuals with a non-zero salary in each category.</p>
<table class="table">
<colgroup>
<col style="width: 14%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>All</th>
<th>FT</th>
<th>PT</th>
<th>M</th>
<th>M FT</th>
<th>M PT</th>
<th>F</th>
<th>F FT</th>
<th>F PT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ONS tot</td>
<td>22-26k</td>
<td>16-19k</td>
<td>6-8k</td>
<td>11-13k</td>
<td>9-11k</td>
<td>1.5-2k</td>
<td>11-13k</td>
<td>6.5-7.5k</td>
<td>4.5-5.5k</td>
</tr>
<tr class="even">
<td>Mod tot H</td>
<td>23.1k</td>
<td>18.5k</td>
<td>4.6k</td>
<td>11.8k</td>
<td>11k</td>
<td>0.8k</td>
<td>11.3k</td>
<td>7.5k</td>
<td>3.8k</td>
</tr>
<tr class="odd">
<td>Mod tot Y</td>
<td>17.6k</td>
<td>14.8k</td>
<td>2.8k</td>
<td>9.4k</td>
<td>8.9k</td>
<td>0.5k</td>
<td>8.2k</td>
<td>5.9k</td>
<td>2.3k</td>
</tr>
</tbody>
</table>
<p>A significant number of individuals listed as working either full or part time have 0 effective worked hours per day according to the Time Use Survey matching. In those cases, an hourly salary is modelled depending on their SOC, region and sex, as for any other employee, but the annual salary will be displayed as 0. It is possible to estimate the likely true number of hours worked from the same ONS dataset (Table 15.9a: Paid hours worked - Total 2020), also depending on their sex, soc and region. This calculation has been added to the “As If” column.</p>
<p><strong>Hourly gross salary per sex and full-time/part-time classification</strong></p>
<table class="table">
<colgroup>
<col style="width: 18%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>All</th>
<th>FT</th>
<th>PT</th>
<th>M</th>
<th>M FT</th>
<th>M PT</th>
<th>F</th>
<th>F FT</th>
<th>F PT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ONS mean</td>
<td>17.63</td>
<td>18.32</td>
<td>13.93</td>
<td>18.81</td>
<td>19.12</td>
<td>14.69</td>
<td>16.19</td>
<td>17.08</td>
<td>13.68</td>
</tr>
<tr class="even">
<td>ONS median</td>
<td>13.71</td>
<td>15.15</td>
<td>10.38</td>
<td>14.84</td>
<td>15.58</td>
<td>10.12</td>
<td>12.58</td>
<td>14.42</td>
<td>10.47</td>
</tr>
<tr class="odd">
<td>Mod mean</td>
<td>16.45</td>
<td>17.19</td>
<td>13.45</td>
<td>17.50</td>
<td>17.84</td>
<td>12.75</td>
<td>15.35</td>
<td>16.23</td>
<td>13.60</td>
</tr>
<tr class="even">
<td>Mod median</td>
<td>13.55</td>
<td>14.46</td>
<td>10.23</td>
<td>14.27</td>
<td>14.72</td>
<td>9.16</td>
<td>12.79</td>
<td>14.12</td>
<td>10.51</td>
</tr>
</tbody>
</table>
<p>The median values are quite close to the ONS values, but the mean values are always lower. This is expected, see the description of the modelling above.</p>
<p><strong>Annual gross salary per sex and full-time/part-time classification</strong></p>
<p>Only values &gt; 0 are retained for these calculations.</p>
<table class="table">
<colgroup>
<col style="width: 15%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>All</th>
<th>FT</th>
<th>PT</th>
<th>M</th>
<th>M FT</th>
<th>M PT</th>
<th>F</th>
<th>F FT</th>
<th>F PT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ONS mean</td>
<td>31,646</td>
<td>38,552</td>
<td>13,819</td>
<td>38,421</td>
<td>42,072</td>
<td>14,796</td>
<td>24,871</td>
<td>33,253</td>
<td>13,512</td>
</tr>
<tr class="even">
<td>ONS median</td>
<td>25,886</td>
<td>31,487</td>
<td>11,240</td>
<td>31,393</td>
<td>33,915</td>
<td>10,883</td>
<td>20,614</td>
<td>28,002</td>
<td>4,743</td>
</tr>
<tr class="odd">
<td>Mod mean</td>
<td>34,317</td>
<td>36,595</td>
<td>22,257</td>
<td>37,574</td>
<td>38,496</td>
<td>20,698</td>
<td>30,594</td>
<td>33,729</td>
<td>22,585</td>
</tr>
<tr class="even">
<td>Mod median</td>
<td>28,713</td>
<td>30,942</td>
<td>17,928</td>
<td>31,404</td>
<td>32,382</td>
<td>17,382</td>
<td>25,875</td>
<td>29,028</td>
<td>18,137</td>
</tr>
</tbody>
</table>
<p>The average salary for part-time employees is correct when values equal to 0 are taken into account. This suggests that the total number of hours worked for part-time employees is correct, but the way they are distributed among individuals is not. It could be due to the TUS taking a snapshot of the situation during a particular week, rather than averaging their data over the year. It appears that the TUS matching also overestimates the average number of hours worked for female employees.</p>
<p><strong>Regional differences (hourly gross salary)</strong></p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 4%">
<col style="width: 11%">
<col style="width: 5%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 11%">
<col style="width: 21%">
</colgroup>
<thead>
<tr class="header">
<th>Region</th>
<th>East</th>
<th>East Midlands</th>
<th>London</th>
<th>North East</th>
<th>North West</th>
<th>South East</th>
<th>South West</th>
<th>West Midlands</th>
<th>Yorkshire and The Humber</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ONS mean</td>
<td>16.74</td>
<td>15.87</td>
<td>23.78</td>
<td>15.69</td>
<td>16.36</td>
<td>17.88</td>
<td>16.36</td>
<td>16.34</td>
<td>15.76</td>
</tr>
<tr class="even">
<td>ONS median</td>
<td>13.28</td>
<td>12.65</td>
<td>18.30</td>
<td>12.40</td>
<td>12.90</td>
<td>14.33</td>
<td>12.74</td>
<td>12.92</td>
<td>12.46</td>
</tr>
<tr class="odd">
<td>Mod mean</td>
<td>16.67</td>
<td>15.29</td>
<td>19.39</td>
<td>15.05</td>
<td>15.22</td>
<td>17.34</td>
<td>15.92</td>
<td>15.47</td>
<td>14.41</td>
</tr>
<tr class="even">
<td>Mod median</td>
<td>13.69</td>
<td>12.79</td>
<td>16.25</td>
<td>12.42</td>
<td>12.44</td>
<td>14.84</td>
<td>13.35</td>
<td>12.64</td>
<td>12.44</td>
</tr>
</tbody>
</table>
<p>The pearson correlations for mean and median between the modelled and raw values are 0.92 and and 0.93.</p>
<p><strong>Hourly gross salary per one-digit SOC</strong></p>
<table class="table">
<colgroup>
<col style="width: 18%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th>1d SOC</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ONS mean</td>
<td>26.77</td>
<td>23.38</td>
<td>18.29</td>
<td>13.42</td>
<td>13.35</td>
<td>10.87</td>
<td>10.94</td>
<td>12.23</td>
<td>10.77</td>
</tr>
<tr class="even">
<td>ONS median</td>
<td>20.96</td>
<td>21.34</td>
<td>15.66</td>
<td>11.54</td>
<td>12.04</td>
<td>10.08</td>
<td>9.52</td>
<td>10.93</td>
<td>9.22</td>
</tr>
<tr class="odd">
<td>Mod mean</td>
<td>21.52</td>
<td>22.14</td>
<td>16.00</td>
<td>12.76</td>
<td>12.55</td>
<td>10.49</td>
<td>10.50</td>
<td>12.05</td>
<td>9.87</td>
</tr>
<tr class="even">
<td>Mod median</td>
<td>17.22</td>
<td>20.66</td>
<td>14.12</td>
<td>11.46</td>
<td>11.34</td>
<td>9.71</td>
<td>9.59</td>
<td>10.82</td>
<td>9.12</td>
</tr>
</tbody>
</table>
<ol type="1">
<li>Managers, directors and senior officials</li>
<li>Professional occupations</li>
<li>Associate professional and technical occupations</li>
<li>Administrative and secretarial occupations</li>
<li>Skilled trades occupations</li>
<li>Caring, leisure and other service occupations</li>
<li>Sales and customer service occupations</li>
<li>Process, plant and machine operatives</li>
<li>Elementary occupations.</li>
</ol>
<p>The Pearson correlations for mean and median between the modelled and raw values are 0.98 and 0.98.</p>
<p><strong>Hourly gross salary per age</strong></p>
<p>The reference for this table is: <a href="https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/earningsandworkinghours/datasets/agegroupashetable6">Table 6.5a Hourly pay - Gross 2020</a></p>
<p>Table before weighting by age:</p>
<table class="table">
<thead>
<tr class="header">
<th>Age</th>
<th>16-17</th>
<th>18-21</th>
<th>22-29</th>
<th>30-39</th>
<th>40-49</th>
<th>50-59</th>
<th>60+</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ONS mean</td>
<td>7.21</td>
<td>9.59</td>
<td>14.09</td>
<td>18.13</td>
<td>20.04</td>
<td>19.12</td>
<td>16.32</td>
</tr>
<tr class="even">
<td>ONS median</td>
<td>6.36</td>
<td>9.00</td>
<td>12.26</td>
<td>15.08</td>
<td>15.89</td>
<td>14.39</td>
<td>12.17</td>
</tr>
<tr class="odd">
<td>Mod mean</td>
<td>12.77</td>
<td>14.96</td>
<td>16.33</td>
<td>16.93</td>
<td>16.83</td>
<td>16.66</td>
<td>16.29</td>
</tr>
<tr class="even">
<td>Mod median</td>
<td>10.93</td>
<td>12.71</td>
<td>13.88</td>
<td>14.02</td>
<td>13.96</td>
<td>13.85</td>
<td>13.65</td>
</tr>
</tbody>
</table>
<p>The Pearson correlations for mean and median between the modelled and raw values are 0.92 and 0.92.</p>
<p>Table after weighting by age:</p>
<table class="table">
<thead>
<tr class="header">
<th>Age</th>
<th>16-17</th>
<th>18-21</th>
<th>22-29</th>
<th>30-39</th>
<th>40-49</th>
<th>50-59</th>
<th>60+</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ONS mean</td>
<td>7.21</td>
<td>9.59</td>
<td>14.09</td>
<td>18.13</td>
<td>20.04</td>
<td>19.12</td>
<td>16.32</td>
</tr>
<tr class="even">
<td>ONS median</td>
<td>6.36</td>
<td>9.00</td>
<td>12.26</td>
<td>15.08</td>
<td>15.89</td>
<td>14.39</td>
<td>12.17</td>
</tr>
<tr class="odd">
<td>Mod mean</td>
<td>9.05</td>
<td>11.15</td>
<td>14.87</td>
<td>17.35</td>
<td>17.96</td>
<td>17.47</td>
<td>15.41</td>
</tr>
<tr class="even">
<td>Mod median</td>
<td>8.20</td>
<td>9.51</td>
<td>12.86</td>
<td>14.41</td>
<td>14.78</td>
<td>14.43</td>
<td>12.56</td>
</tr>
</tbody>
</table>
<p>The Pearson correlations for mean and median between the modelled and raw values are 0.99 and 0.99.</p>
</section>
</section>
<section id="commuting-flows" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="commuting-flows"><span class="header-section-number">11.4</span> Commuting flows</h2>
<section id="list-of-all-workplaces-in-gb" class="level3" data-number="11.4.1">
<h3 data-number="11.4.1" class="anchored" data-anchor-id="list-of-all-workplaces-in-gb"><span class="header-section-number">11.4.1</span> List of all workplaces in GB</h3>
<p>In order to distribute each individual of the population to a unique physical workplace, we first created a population of all individual workplaces in England, based on a combination of the Nomis UK Business Counts 2020 dataset and the Nomis Business register and Employment Survey 2015 (see <a href="./understanding_data_sources.html">Data sources</a>). The first dataset gives the number of individual workplace counts per industry, using the SIC 2007 industry classification, with imprecise size (i.e.&nbsp;number of employees) bands at MSOA level. The second dataset gives the total number of jobs available at LSOA level per SIC 2007 industry category. We found that the distribution of workplace sizes follows closely a simple 1/x distribution, allowing us to draw for each workplace a size within their band, with sum constraints given by the total number of jobs available, according to the second dataset. The <i>R</i> codes to create the list of all workplaces can be found <a href="https://github.com/alan-turing-institute/uatk-spc/blob/main/scripts/data_prep/raw_to_prepared_Workplaces.R">here</a>.</p>
</section>
<section id="usage-inside-spc" class="level3" data-number="11.4.2">
<h3 data-number="11.4.2" class="anchored" data-anchor-id="usage-inside-spc"><span class="header-section-number">11.4.2</span> Usage inside SPC</h3>
<p>The workplace ‘population’ and individual population are levelled for each SIC 2007 category by removing the exceeding part of whichever dataset lists more items. This takes into account that people and business companies are likely to over-report their working availability (e.g.&nbsp;part time and seasonal contracts are not counted differently than full time contracts, job seekers or people on maternity leave might report the SIC of their last job). This process can be controlled by a threshold in the parameter file that defines the maximal total proportion of workers or jobs that can be removed. If the two datasets cannot be levelled accordingly, the categories are dropped and the datasets are levelled globally. Tests in the West Yorkshire area have shown that when the level 1 SIC, containing 21 unique categories, is used, 90% of the volume of commuting flows were recovered compared to the Nomis commuting OD matrices at MSOA level.</p>
<p>The employees for each workplace are drawn according to the ‘universal law of visitation’, see</p>
<blockquote class="blockquote">
<p>Schläpfer M et al.&nbsp;The universal visitation law of human mobility. Nature 593, 522–527 (2021). (<a href="https://doi.org/10.1038/s41586-021-03480-9">DOI</a>)</p>
</blockquote>
<p>This framework predicts that visitors to any destination follow a simple</p>
<p align="center">
ρ(<i>r</i>,<i>f</i>)= <i>K</i> / (<i>rf</i>)<sup>2</sup>
</p>
<p>distribution, where ρ(<i>r</i>,<i>f</i>) is the density of visitors coming from a distance <i>r</i> with frequency <i>f</i> and <i>K</i> is a balancing constant depending on the specific area. In the context of commuting, it can be assumed that <i>f</i> = 1. Additionally, we only need to weigh potential employees against each other, which removes the necessity to compute explicitly <i>K</i>. In the West Yorkshire test, we found a Pearson coefficient of 0.7 between the predicted flows when aggregated at MSOA level and the OD matrix at MSOA level available from Nomis.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./understanding_technical_overview.html" class="pagination-link  aria-label=" &lt;span="" spc="" pipeline&lt;="" span&gt;"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">The SPC pipeline</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./understanding_data_schema.html" class="pagination-link" aria-label="<span class='chapter-number'>12</span>&nbsp; <span class='chapter-title'>Data schema</span>">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Data schema</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>