<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Synthetic Population Catalyst - 10&nbsp; Technical overview</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./understanding_modelling_methods.html" rel="next">
<link href="./understanding_introduction.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./understanding_introduction.html">Understanding SPC</a></li><li class="breadcrumb-item"><a href="./understanding_technical_overview.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Technical overview</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Synthetic Population Catalyst</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/alan-turing-institute/uatk-spc/tree/main/docs" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./Synthetic-Population-Catalyst.pdf" rel="" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Using SPC</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_outputs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">SPC Outputs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_england_outputs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Outputs for England (Counties)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_wales_outputs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Outputs for Wales (ITL regions)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_scotland_outputs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Outputs for Scotland (Police Divisions)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_use_output.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Using the SPC output file</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_installation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Installation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using_custom_areas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Creating new study areas</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Understanding SPC</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./understanding_introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./understanding_technical_overview.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Technical overview</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./understanding_modelling_methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modelling methods</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./understanding_data_schema.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Data schema</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./understanding_data_sources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Data sources</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Advanced</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./advanced_developer_guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Developer guide</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./advanced_code_walkthrough.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Code walkthrough</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./advanced_performance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Performance</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#phase-1-data-preparation" id="toc-phase-1-data-preparation" class="nav-link active" data-scroll-target="#phase-1-data-preparation"><span class="header-section-number">10.1</span> Phase 1: Data preparation</a>
  <ul class="collapse">
  <li><a href="#spenser" id="toc-spenser" class="nav-link" data-scroll-target="#spenser"><span class="header-section-number">10.1.1</span> SPENSER</a></li>
  <li><a href="#downloading-and-preparation-of-public-data-from-various-sources" id="toc-downloading-and-preparation-of-public-data-from-various-sources" class="nav-link" data-scroll-target="#downloading-and-preparation-of-public-data-from-various-sources"><span class="header-section-number">10.1.2</span> Downloading and preparation of public data from various sources</a></li>
  <li><a href="#enriching-spenser" id="toc-enriching-spenser" class="nav-link" data-scroll-target="#enriching-spenser"><span class="header-section-number">10.1.3</span> Enriching SPENSER</a></li>
  <li><a href="#azure-upload" id="toc-azure-upload" class="nav-link" data-scroll-target="#azure-upload"><span class="header-section-number">10.1.4</span> Azure upload</a></li>
  </ul></li>
  <li><a href="#phase-2-running-spc-for-a-specific-study-area" id="toc-phase-2-running-spc-for-a-specific-study-area" class="nav-link" data-scroll-target="#phase-2-running-spc-for-a-specific-study-area"><span class="header-section-number">10.2</span> Phase 2: Running SPC for a specific study area</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Technical overview</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>SPC is divided into two phases. The data preparation phase relies on scripts that only need to be run once. It is meant to output a postprocessed version of all the raw data sources that allows the model to run smoothly on custom areas. The second phase involves the user choosing a custom area and launching a simulation. It pulls the relevant datasets among the data prepared by the first phase, calculates the different daily activities and formats the results into a single protobuffer file.</p>
<p>We provide in this document a step by step description of running the entire SPC pipeline. For</p>
<p>The full SPC pipeline comprises the following steps.</p>
<ul>
<li><strong>Phase 1</strong> - Data preparation steps:
<ol type="1">
<li>The <a href="https://github.com/nismod/microsimulation">SPENSER</a> model creates a synthetic population with basic demographic information for all of GB.</li>
<li>A <a href="https://github.com/alan-turing-institute/uatk-spc/blob/main/scripts/data_prep/raw_to_prepared.R">script</a> downloads and prepares data from various public sources that will be used throughout the model.</li>
<li>The outputs of SPENSER are enriched using some of the outputs from step 2.</li>
<li>The resulting outputs are uploaded as <code>.csv</code> files to a dedicated Azure repository.</li>
</ol></li>
<li><strong>Phase 2</strong> - Steps after the user has selected a study area:
<ol type="1">
<li>All the data relevant to the study area are pulled from Azure.</li>
<li>Individuals are assigned a single education destination (if under 16) and several potential retail destinations, according to a local version of the <a href="https://github.com/maptube/QUANT_RAMP">QUANT</a> model.</li>
<li>Individuals are assigned a single workplace destination (if above 16), according to the method described <a href="https://alan-turing-institute.github.io/uatk-spc/modelling_methods.html#commuting-flows">here</a>.</li>
<li>The population, its activities and an optional lockdown modelling are gathered into a single <code>.pb</code> file that can be visualised by the <a href="https://alan-turing-institute.github.io/uatk-spc/app/">SPC explorer</a>.</li>
</ol></li>
</ul>
<p>We now explain how to run each step. The theoretical concepts supporting the modelling are presented <a href="./understanding_modelling_methods.html">here</a>.</p>
<p><img src="img/SPC_Schema_full.png" class="img-fluid"></p>
<section id="phase-1-data-preparation" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="phase-1-data-preparation"><span class="header-section-number">10.1</span> Phase 1: Data preparation</h2>
<section id="spenser" class="level3" data-number="10.1.1">
<h3 data-number="10.1.1" class="anchored" data-anchor-id="spenser"><span class="header-section-number">10.1.1</span> SPENSER</h3>
<p>The original <a href="https://github.com/nismod/microsimulation">SPENSER</a> model is made up of 5 different GitHub repositories, operating specific parts of the simulation of a synthetic population (gathering the data from ONS, creating individuals, creating households, assigning individuals to households and projecting the population to future years). We use this <a href="https://github.com/alan-turing-institute/spc-hpc-pipeline">modified version</a> with instructions for running the full pipeline on a <a href="https://github.com/alan-turing-institute/spc-hpc-pipeline/blob/main/scripts/full_pipeline/README.md">single machine</a>.</p>
<p>The SPENSER microsimulation is split into three steps:</p>
<ol type="1">
<li><a href="https://github.com/alan-turing-institute/household_microsynth/tree/f10cb0db80cf9db886644413c0a971892e9a9164#overview">Household synthesis</a>: households are synthesised for a base year (2011) from <a href="https://github.com/alan-turing-institute/household_microsynth/tree/f10cb0db80cf9db886644413c0a971892e9a9164#input-data">census data</a> at OA resolution. These households are then sequentially synthesised for subsequent years using <a href="https://github.com/alan-turing-institute/microsimulation/tree/2373691bd0ff764db129e52ec78d71c58538d9af#static-microsimulation---households">household forecasts</a>.</li>
<li><a href="https://github.com/alan-turing-institute/microsimulation/tree/2373691bd0ff764db129e52ec78d71c58538d9af#static-microsimulation---population">Population synthesis</a>: people are sequentially synthesised using marginal census data on gender, age and ethnicity at MSOA resolution for 2011, with population projections used to derive the marginals beyond the reference census year.</li>
<li><a href="https://github.com/alan-turing-institute/microsimulation/tree/2373691bd0ff764db129e52ec78d71c58538d9af#running-the-assignment-algorithm">Assignment</a>: for a given year, the synthesised population (from step 2) can be assigned to a synthesised household (from step 1), while a <a href="https://github.com/alan-turing-institute/microsimulation/tree/2373691bd0ff764db129e52ec78d71c58538d9af#methodology">“household representative person”</a> from the synthesised population (step 2) is assigned to each synthesised household (from step 1).</li>
</ol>
<p>The result of SPENSER is two separate datasets and a merging key: one dataset for individuals, accurate at MSOA level and containing the <code>sex</code>, <code>age</code> and <code>ethnicity</code> <a href="https://alan-turing-institute.github.io/uatk-spc/data_sources.html#pop_.csv.gz">fields</a>; and one for households, accurate at OA level and containing the <code>OA11CD</code>, <code>HOUSE_nssec8</code>, <code>House_type</code>, <code>HOUSE_typeCommunal</code>, <code>HOUSE_NRooms</code>, <code>HOUSE_centralHeat</code>, <code>HOUSE_tenure</code> and <code>HOUSE_NCars</code> <a href="https://alan-turing-institute.github.io/uatk-spc/data_sources.html#pop_.csv.gz">fields</a> respectively.</p>
</section>
<section id="downloading-and-preparation-of-public-data-from-various-sources" class="level3" data-number="10.1.2">
<h3 data-number="10.1.2" class="anchored" data-anchor-id="downloading-and-preparation-of-public-data-from-various-sources"><span class="header-section-number">10.1.2</span> Downloading and preparation of public data from various sources</h3>
<p>Instructions to run this step from the source code can be found under <a href="https://github.com/alan-turing-institute/uatk-spc/tree/main/scripts/data_prep">Step 1: Curate public data from diverse sources</a>. The result is a set of data files, some of which will be merged with the outputs from SPENSER during the next step, containing:</p>
<ul>
<li>NSSEC8 distributions among the population of England and Wales by age group and sex at MSOA level (<code>NSSEC8_EW_F_16to24_CLEAN.csv</code>, etc.) and among the total population of Scotland by age group, sex and ethnicity (<code>NSSECS_CLEAN.csv</code>)</li>
<li>A combined extract from the three latest GB Health Surveys (<code>HSComplete.csv</code>)</li>
<li>An extract from the UK Time Use Survey 2015 (<code>indivTUS.csv</code>)</li>
<li>A file containing a set of coefficients to estimate the average BMI of individuals in England depending on their age, sex and ethnicity (<code>BMIdMean.csv</code>) and a file containing coefficients to obtain the equivalent average BMI in Scotland and Wales (<code>BMIdiff.csv</code>)</li>
<li>Coefficients to estimate the hourly salary of an employee in England depending on their home region, sex, part-time/full-time status, age and SOC category (<code>coefFFT.csv</code>, etc. &amp; <code>ageRescaleFFT.csv</code>, etc.).</li>
<li>Coefficients to estimate the numbers of hours worked corresponding to the criteria mentioned above (<code>meanHoursFFT.csv</code>, etc. and <code>distribHours.csv</code>)</li>
<li>Centroid coordinates of Output areas in GB (<code>OACentroids.csv</code>)</li>
</ul>
<p>In addition, four files to be used by the second phase of the model are outputted:</p>
<ul>
<li><code>diariesRef.csv</code> contains diaries of typical days extracted from the UK Time Use Survey</li>
<li><code>businessRegistry.csv</code> contains a list of all individual workplaces in GB</li>
<li><code>timeAtHomeIncreaseCTY.csv</code> contains a reduction in time spent away from home during the pandemic according to Google Mobility reports</li>
<li><code>lookUp-GB.csv</code> is a comprehensive lookup table between GB geographies, including name variants used by Google and OSM and local file names for storage within Azure</li>
</ul>
<p>To understand the methods supporting the creation of these files, we refer the reader to the corresponding section inside the <a href="https://alan-turing-institute.github.io/uatk-spc/modelling_methods.html">modelling methods</a> section.</p>
</section>
<section id="enriching-spenser" class="level3" data-number="10.1.3">
<h3 data-number="10.1.3" class="anchored" data-anchor-id="enriching-spenser"><span class="header-section-number">10.1.3</span> Enriching SPENSER</h3>
<p>Instructions to run this step can be found under <a href="https://github.com/alan-turing-institute/uatk-spc/tree/main/scripts/data_prep">Step 2: Add to SPENSER</a>. Line numbers quoted in the following refer to this <a href="https://github.com/alan-turing-institute/uatk-spc/blob/main/scripts/data_prep/SPC_pipelineLAD.R">script</a>.</p>
<p>Once merged into one dataset according to the matching key (l. 13-49), the SPENSER data is enriched with the outputs of the previous step. An individual among those sharing the same 5-year age group (extra details for under 18) and sex is drawn from the participants of the Health Survey (l. 56-72). This adds the <code>id_HS</code>, <code>HEALTH_diabetes</code>, <code>HEALTH_bloodpressure</code>, <code>HEALTH_cvd</code>, <code>HEALTH_NMedecines</code>, <code>HEALTH_selfAssessed</code> and <code>HEALTH_lifeSat</code> <a href="https://alan-turing-institute.github.io/uatk-spc/data_sources.html#pop_.csv.gz">fields</a>. This join is not spatially differentiated and other matching criteria (ethnicity and nssec8) were retained due to a lack of representativity inside the survey. The BMI field is then added l. 74-89, according to <a href="https://alan-turing-institute.github.io/uatk-spc/modelling_methods.html#bmi-estimation">this method</a>.</p>
<p>Each individual that is not a head of household is assigned an nssec8 category (l. 96-108). This is done according to nssec8 category distributions among the general population by sex and age groups according to ONS data (<a href="https://www.nomisweb.co.uk/census/2011/dc6114ew">DC6114EW</a> and <a href="https://www.nrscotland.gov.uk/news/2014/census-2011-release-3i">DC6206SC</a> datasets). An individual among those sharing the same 5-year age group, sex and nssec8 category is drawn from the participants of the UK Time Use Survey (l. 111-125). This adds the <code>id_TUS_hh</code>, <code>id_TUS_p</code>, <code>pwkstat</code>, <code>soc2010</code>, <code>sic1d2007</code>, <code>sic2d2007</code>, <code>netPayWeekly</code> and <code>workedHoursWeekly</code> <a href="https://alan-turing-institute.github.io/uatk-spc/data_sources.html#pop_.csv.gz">fields</a>. Note that the <code>netPayWeekly</code> and <code>workedHoursWeekly</code> fields have a low response rate among participants of the survey. For that reason, we have added a <a href="https://alan-turing-institute.github.io/uatk-spc/modelling_methods.html#income-data">much more detailed modelling of income</a>, that includes spatial differences at region level (l. 130-140).</p>
<p>Coordinates of the OA where the household’s home is located are finally added l. 152-156.</p>
</section>
<section id="azure-upload" class="level3" data-number="10.1.4">
<h3 data-number="10.1.4" class="anchored" data-anchor-id="azure-upload"><span class="header-section-number">10.1.4</span> Azure upload</h3>
<p>Following enrichment, a final step involves <a href="https://github.com/alan-turing-institute/uatk-spc/tree/main/scripts/data_prep#step-3-merge-lads-to-counties-and-upload-to-azure">grouping LADs into counties</a> and <a href="https://github.com/alan-turing-institute/uatk-spc/blob/main/scripts/data_prep/upload_toAzure.sh">uploading to an Azure container</a> for use as input for Phase 2 below.</p>
</section>
</section>
<section id="phase-2-running-spc-for-a-specific-study-area" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="phase-2-running-spc-for-a-specific-study-area"><span class="header-section-number">10.2</span> Phase 2: Running SPC for a specific study area</h2>
<p>This part is corresponding to the scripts written in Rust. Instructions can be found <a href="https://alan-turing-institute.github.io/uatk-spc/custom_areas.html">here</a>.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./understanding_introduction.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Introduction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./understanding_modelling_methods.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modelling methods</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>