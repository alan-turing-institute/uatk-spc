<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
  <meta charset="utf-8">
  <meta name="generator" content="quarto-0.9.4">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Synthetic Population Catalyst - Getting started</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>

  <script src="site_libs/quarto-nav/quarto-nav.js"></script>
  <script src="site_libs/quarto-nav/headroom.min.js"></script>
  <script src="site_libs/clipboard/clipboard.min.js"></script>
  <meta name="quarto:offset" content="./">
  <script src="site_libs/quarto-search/autocomplete.umd.js"></script>
  <script src="site_libs/quarto-search/fuse.min.js"></script>
  <script src="site_libs/quarto-search/quarto-search.js"></script>
  <script src="site_libs/quarto-html/quarto.js"></script>
  <script src="site_libs/quarto-html/popper.min.js"></script>
  <script src="site_libs/quarto-html/tippy.umd.min.js"></script>
  <script src="site_libs/quarto-html/anchor.min.js"></script>
  <link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
  <link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <script src="site_libs/bootstrap/bootstrap.min.js"></script>
  <link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
  <script id="quarto-search-options" type="application/json">{
    "location": "sidebar",
    "copy-button": false,
    "collapse-after": 2,
    "panel-placement": "start",
    "type": "textbox",
    "limit": 20,
    "language": {
      "search-no-results-text": "No results",
      "search-matching-documents-text": "matching documents",
      "search-copy-link-title": "Copy link to search",
      "search-hide-matches-text": "Hide additional matches",
      "search-more-match-text": "more match in this document",
      "search-more-matches-text": "more matches in this document",
      "search-clear-button-title": "Clear",
      "search-detached-cancel-button-title": "Cancel",
      "search-submit-button-title": "Submit"
    }
  }</script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="styles.css">
</head>
<body class="docked">
<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Getting started</h1>
      <button type="button" class="quarto-btn-toggle btn">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Synthetic Population Catalyst</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Synthetic Population Catalyst</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-using-it" aria-expanded="true">Using it</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-using-it" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-using-it" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./getting_started.html" class="sidebar-item-text sidebar-link active">Getting started</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./outputs.html" class="sidebar-item-text sidebar-link">Outputs</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./running.html" class="sidebar-item-text sidebar-link">Running SPC</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-understanding-it" aria-expanded="true">Understanding it</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-understanding-it" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-understanding-it" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./modelling_methods.html" class="sidebar-item-text sidebar-link">Modelling methods</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_sources.html" class="sidebar-item-text sidebar-link">Data sources</a>
  </div>
</li>
    </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-internals" aria-expanded="true">Internals</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-internals" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-internals" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./developer_guide.html" class="sidebar-item-text sidebar-link">Developer guide</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./code_walkthrough.html" class="sidebar-item-text sidebar-link">Code walkthrough</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./performance.html" class="sidebar-item-text sidebar-link">Performance</a>
  </div>
</li>
    </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
<h2 id="toc-title">On this page</h2>
<ul>
<li><a href="#python" class="nav-link active" data-scroll-target="#python">Python</a>
<ul class="collapse">
<li><a href="#example-converting-to-json" class="nav-link" data-scroll-target="#example-converting-to-json">Example: converting to JSON</a></li>
<li><a href="#example-convert-to-numpy-arrays" class="nav-link" data-scroll-target="#example-convert-to-numpy-arrays">Example: convert to numpy arrays</a></li>
</ul></li>
<li><a href="#example-draw-all-venues" class="nav-link" data-scroll-target="#example-draw-all-venues">Example: draw all venues</a></li>
<li><a href="#understand-the-schema" class="nav-link" data-scroll-target="#understand-the-schema">Understand the schema</a>
<ul class="collapse">
<li><a href="#flows" class="nav-link" data-scroll-target="#flows">Flows</a></li>
</ul></li>
</ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">
<header id="title-block-header">
<h1 class="title d-none d-lg-block display-7">Getting started</h1>
</header>

<p>SPC generates output for many study areas, including all of the counties in England. If the area you want to model is listed or you just want to explore the data, no need to run SPC yourself – just <a href="./outputs.html">download data for your area</a>.</p>
<p>There’s one <code>.pb.gz</code> file per study area. After decompressing the <code>.gz</code>, you have a <code>.pb</code> file. The data uses <a href="https://developers.google.com/protocol-buffers/docs/overview">protocol buffers</a> to efficiently encode its <a href="https://github.com/alan-turing-institute/uatk-spc/blob/main/synthpop.proto">schema</a>. You can read the “protobuf” (shorthand for a protocol buffer file) in any <a href="https://developers.google.com/protocol-buffers/docs/overview#cross-lang">supported language</a>, and then extract and transform just the parts of the data you want.</p>
<section id="python" class="level2">
<h2 class="anchored" data-anchor-id="python">Python</h2>
<p>To work with SPC protobufs in Python, you need two dependencies setup:</p>
<ul>
<li>The <a href="https://pypi.org/project/protobuf/">protobuf</a> library
<ul>
<li>You can install system-wide with <code>pip install protobuf</code></li>
<li>Or add as a dependency to a conda, poetry, etc environment</li>
</ul></li>
<li>The generated Python library, <a href="https://raw.githubusercontent.com/alan-turing-institute/uatk-spc/main/python/synthpop_pb2.py">synthpop_pb2.py</a>
<ul>
<li>You can download a copy of this file into your codebase, then <code>import synthpop_pb2</code></li>
<li>You can also generate the file yourself, following the <a href="https://developers.google.com/protocol-buffers/docs/reference/python-generated">docs</a>: <code>protoc --python_out=python/ synthpop.proto</code></li>
</ul></li>
</ul>
<section id="example-converting-to-json" class="level3">
<h3 class="anchored" data-anchor-id="example-converting-to-json">Example: converting to JSON</h3>
<p>To interactively explore the data, viewing JSON is much easier. It shows the same structure as the protobuf, but in a human-readable text format. The example below uses a <a href="https://github.com/alan-turing-institute/uatk-spc/blob/main/python/protobuf_to_json.py">small Python script</a>:</p>
<pre class="shell"><code># Download a file
wget https://ramp0storage.blob.core.windows.net/spc-output/v1/rutland.pb.gz
# Uncompress
gunzip rutland.pb.gz
# Convert the .pb to JSON
python3 python/protobuf_to_json.py data/output/rutland.pb &gt; rutland.json
# View the output
less rutland.json</code></pre>
</section>
<section id="example-convert-to-numpy-arrays" class="level3">
<h3 class="anchored" data-anchor-id="example-convert-to-numpy-arrays">Example: convert to numpy arrays</h3>
<p>The <a href="https://github.com/alan-turing-institute/uatk-aspics">ASPICS</a> project simulates the spread of COVID through a population. The code uses numpy, and <a href="https://github.com/alan-turing-institute/uatk-aspics/blob/main/convert_snapshot.py">this script</a> converts the protobuf to a bunch of different numpy arrays.</p>
<p>Note the code doesn’t keep using classes from the generated Python code for protobufs. The protobuf is a format optimized for reading and writing; you shouldn’t use it in your model if there’s a more appropriate tool you’re familiar with, like data frames.</p>
</section>
</section>
<section id="example-draw-all-venues" class="level2">
<h2 class="anchored" data-anchor-id="example-draw-all-venues">Example: draw all venues</h2>
<p><a href="https://github.com/alan-turing-institute/uatk-spc/blob/main/python/draw_venues.py">This script</a> reads a protobuf file, then draws a dot for every venue, color-coded by activity.</p>
<p><img src="img/venues.gif" class="img-fluid"></p>
</section>
<section id="understand-the-schema" class="level2">
<h2 class="anchored" data-anchor-id="understand-the-schema">Understand the schema</h2>
<p>Here are some helpful tips for understanding the <a href="https://github.com/alan-turing-institute/uatk-spc/blob/main/synthpop.proto">schema</a>.</p>
<p>Each .pb file contains exactly one <code>Population</code> message. In contrast to datasets consisting of multiple <code>.csv</code> files, just a single file contains everything. Some of the fields in <code>Population</code> are lists (of people and households) or maps (of venues keyed by activity, or of MSOAs). Unlike a flat <code>.csv</code> table, there may be more lists embedded later. Each <code>Household</code> has a list of <code>members</code>, for example.</p>
<p>The different objects refer to each other, forming a graph structure. The protobuf uses <code>uint64</code> IDs to index into other lists. For example, if some household has <code>members = [3, 10]</code>, then those two people can be found at <code>population.people[3]</code> and <code>population.people[10]</code>. Each of them will have the same <code>household</code> ID, pointing back to something in the <code>population.households</code> list.</p>
<section id="flows" class="level3">
<h3 class="anchored" data-anchor-id="flows">Flows</h3>
<p>SPC models daily travel behavior of people as “flows.” Flows are broken down by by an <a href="https://github.com/alan-turing-institute/uatk-spc/blob/feffb857c6fbbd7c2b3dd1f3cb46e67677185897/synthpop.proto#L196">activity</a> – shopping/retail, attending primary or secondary school, working, or staying at home. For each activity type, a person has a list of venues where they may do that activity, weighted by a probability of going to that particular venue.</p>
<p>Note that <code>flows_per_activity</code> is stored in <code>InfoPerMSOA</code>, not <code>Person</code>. The flows for retail and school are only known at the MSOA level, not individually. So given a particular <code>Person</code> object, you first look up their household’s MSOA – <code>msoa = population.households[ person.household ].msoa</code> and then look up flows for that MSOA – <code>population.info_per_msoa[msoa].flows_per_activity</code>.</p>
<p>Each person has exactly 1 flow for home – it’s just <code>person.household</code> with probability 1. A person has 0 or 1 flows to work, based on the value of <code>person.workplace</code>.</p>
<p>This doesn’t mean that all people in the same MSOA share the same travel behavior. Each person has their own <code>activity_durations</code> field, based on time-use survey data. Even if two people share the same set of places where they may go shopping, one person may spend much more time on that activity than another.</p>
<p>See the <a href="https://github.com/alan-turing-institute/uatk-aspics/blob/c8ad47cb01b084028b2f8ca90fcf078470efbee0/convert_snapshot.py#L166">ASPICS conversion script</a> for all of this in action – it has a function to collapse a person’s flows down into a single weighted list.</p>
<p>How do you interpret the probabilities/weights for flows? If your model needs people to visit specific places each day, you could randomly sample a venue from the flows, weighting them appropriately. For retail, you may want to repeat this sampling every day of the simulation, so they visit different venues. For primary and secondary school, it may be more appropriate to sample once and store that for the simulation – a student probably doesn’t switch schools daily.</p>
<p>Alternatively, you can follow what ASPICS does. Every day, each person logically visits all possible venues, but their interaction there (possibly receiving or transmitting COVID) is weighted by the probability of each venue.</p>


</section>
</section>
</main> <!-- /main -->
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    setTimeout(function() {
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->


</body></html>